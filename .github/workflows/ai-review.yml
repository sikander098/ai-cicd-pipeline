name: AI Code Review (Gemini 1.5 Flash)

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch: # Allow manual trigger

jobs:
  review:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Get PR Diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "Different lines: $(wc -l < pr_diff.txt)"
      
      - name: AI Code Review
        env:
          OLLAMA_ENDPOINT: "http://localhost:11434/api/generate"
        run: |
          pip install requests
          python scripts/ai_reviewer.py \
            --diff pr_diff.txt \
            --output review.md \
            --model "qwen2.5-coder:7b" \
            --endpoint "http://localhost:11434/api/generate"
      
      - name: Post Review Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const review = fs.readFileSync('review.md', 'utf8');
              const body = `## ðŸ¤– AI Code Review (Gemini 1.5 Flash)\n\n${review}`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.log("Error posting comment: " + error);
            }
