name: AI Code Review (Gemini 1.5 Flash)

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch: # Allow manual trigger

jobs:
  review:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      

      
      - name: Get PR Diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "Different lines: $(wc -l < pr_diff.txt)"
      
      - name: AI Code Review
        run: |
          docker run --rm -v "${{ github.workspace }}:/app" -w /app python:3.9-slim /bin/sh -c "pip install requests && python scripts/ai_reviewer.py --diff pr_diff.txt --output review.md --model 'qwen2.5-coder:7b' --endpoint 'http://host.docker.internal:11434/api/generate'"
      
      - name: Post Review Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const review = fs.readFileSync('review.md', 'utf8');
              const body = `## ðŸ¤– AI Code Review (Gemini 1.5 Flash)\n\n${review}`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.log("Error posting comment: " + error);
            }
