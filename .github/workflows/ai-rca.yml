name: AI Root Cause Analysis

on:
  workflow_run:
    workflows: ["Simulate Build Failure"] # Triggers when our test failure runs
    types: [completed]

jobs:
  analyze-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: self-hosted
    permissions:
      contents: read
      actions: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Build Logs
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const logs = await github.rest.actions.downloadWorkflowRunLogs({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.payload.workflow_run.id
              });
              fs.writeFileSync('logs.zip', Buffer.from(logs.data));
              console.log("‚úÖ Logs downloaded to logs.zip");
            } catch (error) {
              console.log("‚ùå Error downloading logs: " + error);
              // Create dummy log for demo if download fails (e.g. artifact retention)
              fs.writeFileSync('logs.zip', ''); 
            }
            
      - name: AI Root Cause Analysis
        shell: cmd
        run: |
          docker run --rm -v "%GITHUB_WORKSPACE%:/app" -w /app python:3.9-slim /bin/sh -c "apt-get update && apt-get install -y unzip && unzip -o logs.zip -d build_logs && find build_logs -name '*.txt' -exec grep -l 'Error' {} + | head -n 1 | xargs -I {} pip install requests && python scripts/ai_rca.py --logs '{}' --output rca.md --model 'qwen2.5-coder:7b' --endpoint 'http://host.docker.internal:11434/api/generate'"
      
      - name: Post RCA Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const rca = fs.readFileSync('rca.md', 'utf8');
              
              // Find related PR
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: context.payload.workflow_run.head_branch
              });
              
              if (prs.data.length > 0) {
                await github.rest.issues.createComment({
                  issue_number: prs.data[0].number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## üîç AI Root Cause Analysis (Gemini 1.5)\n\n${rca}`
                });
              }
            } catch (error) {
              console.log("Error posting comment: " + error);
            }
